{
    "version": "8.1.1.3",
    "description": "PHPStudy - PHP集成环境工具",
    "homepage": "https://www.xp.cn/",
    "license": "Freeware",
    "url": "https://public.xp.cn/upgrades/phpStudy_64.zip",
    "pre_install": [
        "# 确保持久化目录存在",
        "if (-not (Test-Path \"$persist_dir\\Extensions\")) {",
        "    New-Item -ItemType Directory -Force -Path \"$persist_dir\\Extensions\" | Out-Null",
        "}",
        "if (-not (Test-Path \"$persist_dir\\WWW\")) {",
        "    New-Item -ItemType Directory -Force -Path \"$persist_dir\\WWW\" | Out-Null",
        "}"
    ],
    "installer": {
        "script": [
            "# 使用Inno Setup解压方式安装",
            "$installer = \"$dir\\phpstudy_x64_8.1.1.3.exe\"",
            "if (-not (Test-Path $installer)) {",
            "    Write-Error '安装程序未找到'",
            "    exit 1",
            "}",
            "",
            "# 使用Inno Setup命令行参数进行静默安装",
            "# /VERYSILENT - 完全静默安装，不显示任何界面",
            "# /SUPPRESSMSGBOXES - 抑制所有消息框",
            "# /NORESTART - 安装完成后不重启",
            "# /CLOSEAPPLICATIONS - 关闭可能冲突的应用程序",
            "# /NOCANCEL - 不允许用户取消",
            "# /LOG - 创建安装日志",
            "Write-Host \"正在使用Inno Setup静默安装 PHPStudy...\" -ForegroundColor Yellow",
            "Start-Process -FilePath $installer -ArgumentList \"/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /CLOSEAPPLICATIONS /NOCANCEL /LOG=\"\"$dir\\install.log\"\"\" -Wait -NoNewWindow",
            "",
            "# 等待安装完成",
            "Write-Host \"等待安装完成...\" -ForegroundColor Yellow",
            "Start-Sleep -Seconds 10",
            "",
            "# 验证安装是否成功",
            "if (-not (Test-Path \"$dir\\COM\\phpstudy_pro.exe\")) {",
            "    Write-Warning 'phpstudy_pro.exe 未找到，尝试检查安装日志...'",
            "    if (Test-Path \"$dir\\install.log\") {",
            "        Get-Content \"$dir\\install.log\" -Tail 20 | Write-Host -ForegroundColor Red",
            "    }",
            "    Write-Error '安装失败：phpstudy_pro.exe 未找到'",
            "    exit 1",
            "}",
            "",
            "# 处理持久化目录",
            "Write-Host '设置持久化目录...' -ForegroundColor Yellow",
            "",
            "# 如果安装程序创建了默认的WWW和Extensions目录，将它们移动到持久化目录",
            "if (Test-Path \"$dir\\WWW\" -and -not (Test-Path \"$persist_dir\\WWW\\*\")) {",
            "    Write-Host '移动WWW目录到持久化位置...' -ForegroundColor Cyan",
            "    Get-ChildItem -Path \"$dir\\WWW\" | Copy-Item -Destination \"$persist_dir\\WWW\" -Recurse -Force -ErrorAction SilentlyContinue",
            "}",
            "",
            "if (Test-Path \"$dir\\Extensions\" -and -not (Test-Path \"$persist_dir\\Extensions\\*\")) {",
            "    Write-Host '移动Extensions目录到持久化位置...' -ForegroundColor Cyan",
            "    Get-ChildItem -Path \"$dir\\Extensions\" | Copy-Item -Destination \"$persist_dir\\Extensions\" -Recurse -Force -ErrorAction SilentlyContinue",
            "}",
            "",
            "# 删除原始目录并创建符号链接到持久化目录",
            "Remove-Item -Path \"$dir\\WWW\" -Recurse -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\Extensions\" -Recurse -Force -ErrorAction SilentlyContinue",
            "",
            "New-Item -ItemType Junction -Path \"$dir\\WWW\" -Target \"$persist_dir\\WWW\" -Force | Out-Null",
            "New-Item -ItemType Junction -Path \"$dir\\Extensions\" -Target \"$persist_dir\\Extensions\" -Force | Out-Null",
            "",
            "# 清理原始安装文件",
            "Remove-Item -Path \"$dir\\phpstudy_x64_*.exe\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\phpstudy官网链接.url\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\安装路径不能包含中文或空格.txt\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\phpstudyV8使用说明.txt\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\install.log\" -Force -ErrorAction SilentlyContinue"
        ]
    },
    "post_install": [
        "# 安装完成提示",
        "Write-Host '=========================================' -ForegroundColor Green",
        "Write-Host 'PHPStudy 安装完成！' -ForegroundColor Green",
        "Write-Host '=========================================' -ForegroundColor Green",
        "Write-Host ''",
        "Write-Host '主程序位置: $dir\\COM\\phpstudy_pro.exe' -ForegroundColor Yellow",
        "Write-Host '网站目录: $dir\\WWW' -ForegroundColor Yellow",
        "Write-Host '扩展目录: $dir\\Extensions' -ForegroundColor Yellow",
        "Write-Host ''",
        "Write-Host '持久化数据位置: $persist_dir\\' -ForegroundColor Cyan",
        "Write-Host ''",
        "# 创建启动脚本",
        "$startScript = @'",
        "#!/usr/bin/env pwsh",
        "# PHPStudy启动脚本",
        "# 使用Inno Setup参数启动",
        "if (Test-Path \"`$PSScriptRoot\\COM\\phpstudy_pro.exe\") {",
        "    Write-Host '启动 PHPStudy...' -ForegroundColor Green",
        "    # 直接启动程序，Inno Setup已经处理了安装",
        "    Start-Process -FilePath \"`$PSScriptRoot\\COM\\phpstudy_pro.exe\"",
        "} else {",
        "    Write-Error \"phpstudy_pro.exe 未找到，请重新安装\"",
        "}",
        "'@",
        "Set-Content -Path \"$dir\\start-phpstudy.ps1\" -Value $startScript -Encoding UTF8"
    ],
    "uninstaller": {
        "script": [
            "# 使用Inno Setup卸载程序",
            "$uninstaller = \"$dir\\unins000.exe\"",
            "if (Test-Path $uninstaller) {",
            "    Write-Host '正在使用Inno Setup卸载 PHPStudy...' -ForegroundColor Yellow",
            "    # 使用Inno Setup静默卸载参数",
            "    Start-Process -FilePath $uninstaller -ArgumentList \"/VERYSILENT /SUPPRESSMSGBOXES /NORESTART\" -Wait -NoNewWindow",
            "    Start-Sleep -Seconds 5",
            "} else {",
            "    Write-Warning '未找到Inno Setup卸载程序，将直接删除文件'",
            "}",
            "",
            "# 删除符号链接（不删除持久化数据）",
            "Remove-Item -Path \"$dir\\WWW\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item -Path \"$dir\\Extensions\" -Force -ErrorAction SilentlyContinue",
            "",
            "# 确保COM目录也被清理（如果卸载程序没有清理干净）",
            "Remove-Item -Path \"$dir\\COM\" -Recurse -Force -ErrorAction SilentlyContinue"
        ]
    },
    "bin": "start-phpstudy.ps1",
    "persist": [
        "WWW",
        "Extensions"
    ],
    "shortcuts": [
        [
            "COM\\phpstudy_pro.exe",
            "PHPStudy"
        ],
        [
            "start-phpstudy.ps1",
            "PHPStudy (启动脚本)"
        ]
    ],
    "notes": [
        "PHPStudy 使用Inno Setup方式安装",
        "主程序: $dir\\COM\\phpstudy_pro.exe",
        "网站文件目录: $dir\\WWW (符号链接到 $persist_dir\\WWW)",
        "扩展目录: $dir\\Extensions (符号链接到 $persist_dir\\Extensions)",
        "持久化数据位置: $persist_dir\\",
        "安装日志: $dir\\install.log (仅在安装过程中存在)",
        "使用 'scoop run phpstudy' 或开始菜单快捷方式启动程序",
        "卸载: scoop uninstall phpstudy"
    ]
}
